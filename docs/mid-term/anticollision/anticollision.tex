%!TEX program = xelatex

\documentclass[11pt,titlepage]{report}
\input{../../library/import}
\input{../../library/style}
\addbibresource{../../library/bibliography.bib}

\begin{document}

\chapter{Connectivity and sensors}
\label{ch:anticollision}
\section{General limits}
As discussed in deliverable 2, the resolution of the sensors is 1 cm, the maximum distance measurable is \SI{3.1}{m} while the Bluetooth connection is usable up to around \SI{24}{m}. These constitute the general limits of the system; e.g. the limits that can not be improved upon without changing the system fundamentally (using different sensors, for example). Of more interest in terms of optimization are limits imposed by the software and the reliability of the sensors over time. The software limit is mostly in terms of \textit{latency}, or time between communications. The reliability is mostly in the sense of realistic sensor outputs. Both aspects are discussed below. The last paragraph briefly discusses an improvement to the sensor using the Doppler effect, which is not currently implemented.

\section{Latency}
Of great limiting capability to the control of the car is the (wireless) transmission of signals. The given Bluetooth system, operating in the frequency band of \SI{2.4-2.485}{GHz} has a maximum specified range of \SI{100}{m}.  Even though a Bluetooth connection is capable of high throughput (up to \SI{1}{Mbit/s} in the simplest mode), this is not the bottleneck in our scenario. The actual problem is latency, or the delay between sending a signal and receiving a response. In \texttt{MATLAB} we experienced an average latency of around \SI{300}{ms}. In our view, this was unacceptably high, because it leads to various problems: status updates are `old' and the calculations for the next driving instructions are corrupted. To make matters worse, the corrupted driving instructions are received too late by the car again! Unsurprisingly, ways were needed to work around this.
\subsection{Bluetooth latency}
Since the Bluetooth specification dictates that \textit{slot pairs} occur at intervals of \SI{1250}{us} and a packet may be up to 5 slot pairs long, one would expect up to around \SI{6}{ms} delay from communications alone. Neglecting other overhead delays, the goal became to come as close to this number as possible. 

With a background in .NET, and C\# specifically, the decision was made to try Bluetooth communication over C\# instead of \texttt{MATLAB}. After some hours of programming and debugging, a basic communication had been established. Amazingly, the C\# program communicates around 10 to even 30 times faster, with latency's in the order of \SI{10-30}{ms}. After accomplishing this, improvements were made to the program in order to execute useful tasks, among others a gui and an implementation of the control system. These developments are treated more in-depth in their respective sections.

However, whilst the Bluetooth latency was reduced a lot, the acoustic sensors form another delay in the line.
\subsection{Acoustic sensor latency}
The acoustic sensor datasheet specifies that \SI{60}{ms} is the shortest amount of time between two measurements. This means that the output of the sensors change at most every \SI{60}{ms}. Why, then, is it useful to reduce the Bluetooth latency below \SI{60}{ms}? Well, the acoustic sensors are not synchronized with the Bluetooth connection. Essentially, if the output of the acoustic sensor changes, the result is not known to the base PC before asking for a status update. Thus, by reducing the time between \textit{polls} of the acoustic sensor, smaller overall latency is observed.

\section{Reliability}
\subsection{Bluetooth connection reliability}
Establishing a Bluetooth connection using \texttt{MATLAB} takes a couple of tries and sometimes a few resets of the Bluetooth adapter connected to the PC. However, by implementing new code that automatically retries on a failed connection, this was not much of an issue after all. When implemented in C\#, this was no issue at all and the connection was consistently established in the first try. Therefore, we believe the C\# implementation is superior not only in terms of latency but also reliability. It should be noted however, that once a connection is established, the connection is never unintentionally lost, neither in \texttt{MATLAB} nor C\#, within the maximum operating range of the Bluetooth connection.

\subsection{Acoustic sensor reliability}
As concluded in the second deliverable, the sensors themselves have a resolution of \SI{1}{cm} and a small absolute error, at most \SI{2}{cm} for larger distances. Because these are properties of the sensors, no change in software can compensate for this behavior. The pain point  in the reliability of the sensors was that frequently the sensors seemed to malfunction, showing dips in measured distance at unexpected times. An example of this is when the car was stationary and facing a wall with no other objects to interfere at a distance of around 2 meters. Once every 3 to 10 measurements were suddenly incredibly small, in the order of \SI{5}{cm}. We attribute this to defect sensors. In fact, during the demonstration of our system, the right sensor \textit{only} gave values of \SI{5}{cm}, no matter what the distance to the wall was. All in all, it can be argued that the sensors are quite fragile and unpredictable. Therefore, a linear filter was made to predict the next sensor value using the values provided by the state observer. This filter only works when the erroneous values are infrequent, and does not work for broken sensors. The filter is currently in use and replaces an unexpected measured value with the prediction if the measurement is too far from the expectation. Mathematical details of the prediction algorithm can be found in Appendix \ref{app:signal-filtering}.

\section{Improving measurement accuracy}
\subsection{The Doppler effect}
The Doppler effect is a shift in frequency of a wave observed when the observer and wave emitting object are moving relative to one other. Even though the idea is more than one-and-a-half century old, the theory is widely applied today in (medical) imaging, sensor networks, astronomy and many other fields. Of special interest in this case is the frequency shift between the sound waves emitted and received by the acoustic sensor. 
Since the acoustic sensor emits short sound pulses and waits until they are picked up again by the integrated microphone, the Doppler effect implies that the frequency (and hence the period) of the received signals are different than the ones emitted if the vehicle is moving. If there is a way to access this raw information from the sensors, the speed of the car ($v'$) can be extracted. The speed of the car could then be sent back to the PC for processing, or it could be used to improve the accuracy of the sensors: because the new distance $x_{car}$ is given by $x_{car}=d-(T_s+T_p)v'$ with $d$ the previous distance, $T_s$ the time between the emitted pulses and the time they are received and $T_p$ the time required to process all this information. Thus, using this information along with the information from the actual distance sensors could give improvements to the measurements from the sensors. Appendix \ref{app:signal-filtering} gives more mathematical details of the Doppler effect in this scenario and a derivation of the equation above. Unfortunately, there is no way to access the information from the sensor in this project, and the data analysis from the sensors is handled by KITT without possibilities to interfere.
\end{document}